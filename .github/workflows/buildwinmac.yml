name: Build MuPDF Native Libraries

on:
  workflow_dispatch:

jobs:
  build-linux:
    name: Build MuPDF (manylinux2014)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # This step is still needed so ${{ github.workspace }} exists
        # for the volume mount and for the artifact upload.

      # STEP 1: Removed the "Clone MuPDF" step from the host.
      # We will now do this INSIDE the container.

      - name: Build MuPDF inside manylinux2014 container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/work \
            -w /work \
            quay.io/pypa/manylinux2014_x86_64 \
            bash -c "
              set -e
              # STEP 2: Add 'git' to the list of yum dependencies
              yum install -y git harfbuzz-devel freetype-devel libjpeg-turbo-devel \
                               openjpeg2-devel libpng-devel bzip2-devel zlib-devel \
                               libcurl-devel openssl-devel cmake3
              ln -s /usr/bin/cmake3 /usr/bin/cmake || true

              # STEP 3: Clone MuPDF *inside* the container's /work directory
              git clone --depth 1 --recurse-submodules https://github.com/ArtifexSoftware/mupdf.git

              # Now, cd into the newly cloned directory and build
              cd mupdf
              make shared=yes build=release libs
              
              # The build artifacts will be at /work/mupdf/build/shared-release,
              # which maps to ${{ github.workspace }}/mupdf/build/shared-release
              # on the host, where upload-artifact will find them.
            "

      - name: Upload native libraries (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: mupdf-native-Linux-x86_64
          # This path is relative to ${{ github.workspace }} and will
          # now be populated by the container.
          path: mupdf/build/shared-release/*.so*

  build-macos-intel:
    name: Build MuPDF (macOS, Intel)
    runs-on: macos-12
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone MuPDF
        run: git clone --depth 1 --recurse-submodules https://github.com/ArtifexSoftware/mupdf.git

      - name: Install dependencies (macOS)
        run: |
          brew update
          brew install cmake harfbuzz freetype libjpeg libpng bzip2 zlib curl openssl

      - name: Build MuPDF (macOS, Intel)
        run: |
          cd mupdf
          make shared=yes build=release libs

      - name: Upload native libraries (macOS, Intel)
        uses: actions/upload-artifact@v4
        with:
          name: mupdf-native-macOS-x86_64
          path: mupdf/build/shared-release/*.dylib*

  build-macos-arm:
    name: Build MuPDF (macOS, Apple Silicon)
    runs-on: macos-latest
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone MuPDF
        # FIX (from last time): Added --recurse-submodules
        run: git clone --depth 1 --recurse-submodules https://github.com/ArtifexSoftware/mupdf.git

      - name: Install dependencies (macOS)
        run: |
          brew update
          brew install cmake harfbuzz freetype libjpeg libpng bzip2 zlib curl openssl

      - name: Build MuPDF (macOS, Apple Silicon)
        run: |
          cd mupdf
          make shared=yes build=release libs

      - name: Upload native libraries (macOS, Apple Silicon)
        uses: actions/upload-artifact@v4
        with:
          name: mupdf-native-macOS-arm64
          path: mupdf/build/shared-release/*.dylib*
