name: Build MuPDF Native Libraries

on:
  workflow_dispatch:
    # STEP 1: Add an 'inputs' block to create the dropdown
    inputs:
      platform:
        type: choice
        description: "Which platform to build?"
        required: true
        default: "all"
        options:
          - all
          - linux
          - macos-intel
          - macos-arm

jobs:
  build-linux:
    name: Build MuPDF (manylinux2014)
    # STEP 2: Add an 'if' condition to the job
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'linux'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build MuPDF inside manylinux2014 container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/work \
            -w /work \
            quay.io/pypa/manylinux2014_x86_64 \
            bash -c "
              set -e
              yum install -y git harfbuzz-devel freetype-devel libjpeg-turbo-devel \
                               openjpeg2-devel libpng-devel bzip2-devel zlib-devel \
                               libcurl-devel openssl-devel cmake3
              ln -s /usr/bin/cmake3 /usr/bin/cmake || true

              git clone --depth 1 --recurse-submodules https://github.com/ArtifexSoftware/mupdf.git
              
              cd mupdf
              make shared=yes build=release libs
            "

      - name: Upload native libraries (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: mupdf-native-Linux-x86_64
          path: mupdf/build/shared-release/*.so*

  build-macos-intel:
    name: Build MuPDF (macOS, Intel)
    # STEP 2: Add an 'if' condition to the job
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'macos-intel'
    runs-on: macos-12
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone MuPDF
        run: git clone --depth 1 --recurse-submodules https://github.com/ArtifexSoftware/mupdf.git

      - name: Install dependencies (macOS)
        run: |
          brew update
          brew install cmake harfbuzz freetype libjpeg libpng bzip2 zlib curl openssl

      - name: Build MuPDF (macOS, Intel)
        run: |
          cd mupdf
          make shared=yes build=release libs

      - name: Upload native libraries (macOS, Intel)
        uses: actions/upload-artifact@v4
        with:
          name: mupdf-native-macOS-x86_64
          path: mupdf/build/shared-release/*.dylib*

  build-macos-arm:
    name: Build MuPDF (macOS, Apple Silicon)
    # STEP 2: Add an 'if' condition to the job
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'macos-arm'
    runs-on: macos-latest
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone MuPDF
        run: git clone --depth 1 --recurse-submodules https://github.com/ArtifexSoftware/mupdf.git

      - name: Install dependencies (macOS)
        run: |
          brew update
          brew install cmake harfbuzz freetype libjpeg libpng bzip2 zlib curl openssl

      - name: Build MuPDF (macOS, Apple Silicon)
        run: |
          cd mupdf
          make shared=yes build=release libs

      - name: Upload native libraries (macOS, Apple Silicon)
        uses: actions/upload-artifact@v4
        with:
          name: mupdf-native-macOS-arm64
          path: mupdf/build/shared-release/*.dylib*
